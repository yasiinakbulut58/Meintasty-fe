name: Deployment

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build-and-deploy:
    runs-on: [self-hosted]

    steps:
      - uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 20
          cache: npm

      - name: Build
        run: |
          npm install
          npm run build

      - name: Deploy
        run: |
          try {
            if ((Get-WebSiteState -Name "Default Web Site").Value -eq "Started") {
              Stop-WebSite -Name "Default Web Site"
              Write-Output "Stopped Website Default Web Site"
            }
            if ((Get-WebAppPoolState -Name "Default Web Site").Value -eq "Started") {
              Stop-WebAppPool -Name "Default Web Site"
              Write-Output "Stopped Application Pool Default Web Site"
            }

            Start-Sleep -s 5

            $sourcePath = "C:\actions-runner\_work\Meintasty-fe\Meintasty-fe"
            $destinationPath = "C:\inetpub\wwwroot"

            robocopy $sourcePath $destinationPath /MIR /MT:16
            Write-Output "Files copied from $sourcePath to $destinationPath using Robocopy"

            if ((Get-WebSiteState -Name "Default Web Site").Value -eq "Stopped") {
              Start-WebSite -Name "Default Web Site"
              Write-Output "Started Website Default Web Site"
            }
            if ((Get-WebAppPoolState -Name "Default Web Site").Value -eq "Stopped") {
              Start-WebAppPool -Name "Default Web Site"
              Write-Output "Started Application Pool Default Web Site"
            }

            if ($lastexitcode -lt 8) { $global:lastexitcode = 0 }
          } catch {
            Write-Error "An error occurred during deployment: $_"
            exit 1
          }
